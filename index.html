<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Anti-Harcèlement Scolaire V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Le contenu de l'application sera injecté ici par JavaScript -->
    </div>

    <script>
        // Le script complet de l'application V2
        let appState = {};
        let currentUser = null;
        const adminPassword = '@dmiP@steur2025';

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApplication();
        });

        async function initializeApplication() {
            await loadState();
            document.getElementById('app').innerHTML = getAppHTML();
            updateDisplay();
            setupEventListeners();
            showHome();
        }

        async function loadState() {
            try {
                const response = await fetch('/api/state');
                if (!response.ok) {
                    throw new Error(`Erreur réseau: ${response.statusText}`);
                }
                appState = await response.json();
            } catch (error) {
                console.error("Impossible de charger les données depuis le serveur:", error);
                document.body.innerHTML = `<div class="p-4 text-center text-red-500 bg-white rounded-lg">Erreur critique: Impossible de contacter le serveur. Veuillez vérifier que le serveur est bien démarré (avec la commande 'node server.js') et actualiser la page.</div>`;
            }
        }

        async function saveState() {
            try {
                const response = await fetch('/api/state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState)
                });
                if (!response.ok) {
                    throw new Error(`Erreur réseau: ${response.statusText}`);
                }
                const result = await response.json();
                console.log('Sauvegarde réussie:', result.message);
            } catch (error) {
                console.error("Impossible de sauvegarder les données sur le serveur:", error);
                alert("Erreur critique : La connexion avec le serveur a été perdue. Vos dernières modifications n'ont peut-être pas été sauvegardées.");
            }
        }

        function getAppHTML() {
            return document.getElementById('v2/index.html').innerHTML;
        }

        function updateDisplay() {
            if (appState.schoolName) {
                document.getElementById('schoolTitle').textContent = appState.schoolName;
            }
            if (appState.schoolLogo) {
                document.getElementById('logoContainer').innerHTML = `<img src="${appState.schoolLogo}" alt="Logo établissement" class="w-24 h-24 mx-auto rounded-full object-cover">`;
            } else {
                document.getElementById('logoContainer').innerHTML = `
                    <div class="w-24 h-24 mx-auto bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>`;
            }
        }

        // ... Le reste des fonctions (setupEventListeners, showHome, etc.)
    </script>
</body>

